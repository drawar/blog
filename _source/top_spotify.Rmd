---
layout: post
title:  "R Markdown"
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}

library(tidyverse)
library(lubridate)
library(httr)

clientID = 'f51419c2803649029d8e248bc3a6c262'
secret = 'dbc54744128f44f9996bf099c3459f79'

get_header_value <- function(client_id, client_secret) {
  token <- POST(
    'https://accounts.spotify.com/api/token',
    accept_json(),
    authenticate(clientID, secret),
    body = list(grant_type = 'client_credentials'),
    encode = 'form',
    verbose()
  ) %>% content %>% .$access_token
  header_value <- paste0('Bearer ', token)
  return(header_value)
}

headerValue <- get_header_value(clientID, secret)
user_id <- 'spotify'
playlist_id <- '37i9dQZF1CyXyPUy57ueoa'

get_playlist_tracks <- function(user_id, playlist_id, header_value) {
    tracks <- GET(paste0('https://api.spotify.com/v1/users/', user_id,'/playlists/', playlist_id, '/tracks'),
                  add_headers(Authorization = header_value)) %>% 
      content %>% 
      .$items 
    
    track_names <- sapply(1:length(tracks), function(t) tracks[[t]]$track$name)
    
    ids <- map(1:length(tracks), function(z) tracks[[z]]$track$id) %>% 
      unlist %>% paste0(collapse=',')
    
    res <- GET(paste0('https://api.spotify.com/v1/audio-features/?ids=', ids),
               add_headers(Authorization = header_value)) %>% content %>% .$audio_features
    
    df <- unlist(res) %>% 
      matrix(nrow = length(res), byrow = T) %>% 
      as.data.frame(stringsAsFactors = F)
    names(df) <- names(res[[1]])
    df['track_name'] <- track_names
    df <- as_tibble(df) %>% 
    # convert from character to numeric
    mutate_at(c('danceability', 'energy', 'key', 'loudness', 'mode', 'speechiness', 'acousticness','instrumentalness', 'liveness', 'valence', 'tempo', 'duration_ms', 'time_signature'), funs(as.numeric(gsub('[^0-9.-e]+', '', as.character(.))))) 
    return(df)
}

top_song <- get_playlist_tracks(user_id, playlist_id, headerValue)
top_song <- top_song %>% select(-c(mode, instrumentalness, liveness, time_signature, uri, track_href, analysis_url, type))
str(top_song)


```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
